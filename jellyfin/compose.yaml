services:
    ts-jellyfin:
        image: tailscale/tailscale:latest
        container_name: ts-jellyfin
        hostname: jellyfin
        environment:
            - TS_AUTHKEY=$TS_AUTHKEY
            - TS_STATE_DIR=/var/lib/tailscale
            - TS_USERSPACE=false
            - TS_SERVE_CONFIG=/config/serve-config.json
        volumes:
            - $PWD/data/ts-jellyfin/state:/var/lib/tailscale
            - $PWD/data/ts-jellyfin/config:/config
        devices:
            - /dev/net/tun:/dev/net/tun
        cap_add:
            - net_admin
        restart: unless-stopped
    jellyfin:
        image: jellyfin/jellyfin:latest
        container_name: jellyfin
        network_mode: service:ts-jellyfin
        depends_on:
            - ts-jellyfin
        volumes:
            - "$PWD/data/jellyfin/config:/config"
            - "$PWD/data/jellyfin/cache:/cache"
            - type: bind
              source: /mnt/nas/MEDIA
              target: /media
              read_only: true
        environment:
            - JELLYFIN_PublishedServerUrl=https://jellyfin.duckbill-karat.ts.net
        restart: "unless-stopped"
